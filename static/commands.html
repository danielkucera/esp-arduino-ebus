<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>esp-eBus Commands</title>
  <link rel="stylesheet" href="common.css">
</head>

<body>
  <h2>Commands Editor</h2>
  <div class="row" style="margin-bottom:8px;">
    <button id="btnHome">Home</button>
    <button id="btnFetch">Load from adapter</button>
    <button id="btnOpenFile" class="secondary">Load from file...</button>
    <button id="btnClear">Clear</button>
    <button id="btnFormat">Format</button>
    <button id="btnEvaluate">Evaluate</button>
    <button id="btnInsert" class="apply">Apply from editor</button>
    <button id="btnDownload" class="secondary">Save as file</button>
    <button id="btnLoad" class="apply">Apply from storage</button>
    <button id="btnSave" class="danger">Save to storage</button>
    <button id="btnWipe" class="danger">Wipe all from storage</button>
    <input type="file" id="fileUpload" style="display:none" accept="application/json">
    <span class="status" id="status"> </span>
    <span id="size">0 bytes</span>
  </div>
  <textarea class="boxsizingBorder" id="commandsArea">Loading...</textarea>
  <div>
    <div class="table-actions">
      <button id="btnEditorToTable">Refresh table from editor</button>
      <label style="margin-left:auto;color:#666;font-size:0.9rem">Table view (read-only)</label>
    </div>
    <table id="commandsTable">
      <thead></thead>
      <tbody></tbody>
    </table>
  </div>
  <script src="common.js"></script>
  <script>
    function updateSize() {
      const txt = document.getElementById('commandsArea').value || '';
      const bytes = new TextEncoder().encode(txt).length;
      const chars = txt.length;
      document.getElementById('size').textContent = bytes + ' bytes (' + chars + ' chars)';
    }

    function fetchCommands() {
      fetchJson('/api/v1/commands/download', js => {
        document.getElementById('commandsArea').value = JSON.stringify(js, null, 2);
        renderTable(js.commands || []);
        setStatus('Fetched');
        updateSize();
      });
    }

    function renderTable(commands) {
      const thead = document.querySelector('#commandsTable thead');
      const tbody = document.querySelector('#commandsTable tbody');
      thead.innerHTML = '';
      tbody.innerHTML = '';
      const keys = new Set();
      commands.forEach(cmd => { Object.keys(cmd || {}).forEach(k => keys.add(k)); });
      const cols = Array.from(keys);
      const trh = document.createElement('tr');
      cols.forEach(k => { const th = document.createElement('th'); th.textContent = k; trh.appendChild(th); });
      thead.appendChild(trh);
      commands.forEach(cmd => {
        const tr = document.createElement('tr');
        cols.forEach(k => {
          const td = document.createElement('td');
          td.contentEditable = 'false';
          const v = cmd[k];
          if (typeof v === 'object' && v !== null) td.textContent = JSON.stringify(v);
          else td.textContent = (v === undefined ? '' : String(v));
          tr.appendChild(td);
        });
        tbody.appendChild(tr);
      });
    }

    function editorToTable() {
      try {
        const txt = document.getElementById('commandsArea').value;
        const obj = JSON.parse(txt);
        renderTable(obj.commands || []);
        setStatus('Table updated from editor');
      } catch (err) {
        setStatus('Invalid JSON');
      }
    }

    function handleInsert() {
      try {
        const txt = document.getElementById('commandsArea').value;
        const obj = JSON.parse(txt);
        if (!obj.commands) throw new Error("JSON must include 'commands' array");
        setStatus('Uploading...');
        fetch('/api/v1/commands/insert', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(obj)
        }).then(res => setStatus(res.ok ? 'Uploaded' : 'Upload failed'))
          .catch(() => setStatus('Invalid JSON or upload failed'));
      } catch (err) {
        setStatus('Invalid JSON or upload failed');
      }
    }

    function handleEvaluate() {
      try {
        const txt = document.getElementById('commandsArea').value;
        const obj = JSON.parse(txt);
        if (!obj.commands) throw new Error("JSON must include 'commands' array");
        setStatus('Evaluating...');
        fetch('/api/v1/commands/insert', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(obj)
        }).then(async res => {
          const text = await res.text();
          setStatus(text || (res.ok ? 'Evaluated' : 'Evaluation failed'));
        }).catch(() => setStatus('Invalid JSON or evaluation failed'));
      } catch (err) {
        setStatus('Invalid JSON or evaluation failed');
      }
    }

    document.getElementById('btnHome').addEventListener('click', handleHome);
    document.getElementById('btnClear').addEventListener('click', () => clearTextarea('commandsArea', 'size'));
    document.getElementById('btnFetch').addEventListener('click', fetchCommands);
    document.getElementById('btnInsert').addEventListener('click', handleInsert);
    document.getElementById('btnFormat').addEventListener('click', () => formatTextareaJson('commandsArea'));
    document.getElementById('btnEvaluate').addEventListener('click', handleEvaluate);
    document.getElementById('btnOpenFile').addEventListener('click', () => document.getElementById('fileUpload').click());
    document.getElementById('fileUpload').addEventListener('change', ev => handleJsonFileUpload(ev, 'commandsArea', updateSize));
    document.getElementById('btnDownload').addEventListener('click', () => {
      const text = document.getElementById('commandsArea').value;
      downloadTextFile(text, 'commands.json', 'application/json');
    });
    document.getElementById('btnLoad').addEventListener('click', () => postSimple('/api/v1/commands/load'));
    document.getElementById('btnSave').addEventListener('click', () => postSimple('/api/v1/commands/save'));
    document.getElementById('btnWipe').addEventListener('click', () => {
      if (confirm('Clear all commands from NVS?')) postSimple('/api/v1/commands/wipe');
    });
    document.getElementById('btnEditorToTable').addEventListener('click', editorToTable);

    document.getElementById('commandsArea').addEventListener('input', updateSize);

    // Initial load
    fetchCommands();
  </script>
</body>

</html>