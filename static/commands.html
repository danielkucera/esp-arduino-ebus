<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>esp-eBus Commands</title>
  <link rel="stylesheet" href="common.css">
  <style>
    /* Vertical headers only for the commands table (scoped locally to this page) */
    #commandsTable th {
      writing-mode: vertical-lr;
      -webkit-writing-mode: vertical-lr;
      text-orientation: mixed;
      white-space: nowrap;
      vertical-align: bottom;
      padding: 10px 6px;
      font-size: 12px;
      min-width: 36px;
    }
  </style>
</head>

<body>
  <h2>Commands Editor</h2>
  <div class="row" style="margin-bottom:8px;">
    <button id="btnHome">Home</button>
    <button id="btnFetch">Load from adapter</button>
    <button id="btnOpenFile" class="secondary">Load from file...</button>
    <input id="fileUpload" type="file" style="display:none" accept="application/json">
    <button id="btnClear">Clear</button>
    <button id="btnFormat">Format</button>
    <button id="btnEvaluate">Evaluate</button>
    <button id="btnInsert" class="apply">Apply from editor</button>
    <button id="btnDownload" class="secondary">Save as file</button>
    <button id="btnLoad" class="apply">Apply from storage</button>
    <button id="btnSave" class="danger">Save to storage</button>
    <button id="btnWipe" class="danger">Wipe all from storage</button>
    <span class="status" id="status"> </span>
    <span id="size">0 bytes</span>
  </div>
  <textarea class="boxsizingBorder" id="commandsArea">Loading...</textarea>
  <div>
    <div class="table-actions">
      <button id="btnEditorToTable">Refresh table from editor</button>
      <button id="btnRemoveSelected" class="danger">Remove Selected</button>
      <button id="btnRemoveAll" class="danger">Remove All</button>
      <span id="commandCount" style="margin-left: 10px;">0 commands</span>
      <label style="margin-left:auto;color:#666;font-size:0.9rem">Table view (read-only)</label>
    </div>
    <table id="commandsTable">
      <thead></thead>
      <tbody></tbody>
    </table>
  </div>
  <script src="common.js"></script>
  <script>
    function updateSize() {
      const txt = document.getElementById('commandsArea').value || '';
      const bytes = new TextEncoder().encode(txt).length;
      const chars = txt.length;
      document.getElementById('size').textContent = bytes + ' bytes (' + chars + ' chars)';
    }

    function fetchCommands() {
      fetchJson('/api/v1/commands/download', js => {
        document.getElementById('commandsArea').value = JSON.stringify(js, null, 2);
        renderTable(js.commands || []);
        setStatus('Fetched');
        updateSize();
      });
    }

    function renderTable(commands) {
      const thead = document.querySelector('#commandsTable thead');
      const tbody = document.querySelector('#commandsTable tbody');
      thead.innerHTML = '';
      tbody.innerHTML = '';
      const keys = new Set();

      commands.forEach(cmd => { Object.keys(cmd || {}).forEach(k => keys.add(k)); });
      const cols = Array.from(keys);

      // Add header row with a checkbox for selecting all
      const trh = document.createElement('tr');
      const th = document.createElement('th');
      th.innerHTML = '<input type="checkbox" id="selectAll" />';
      trh.appendChild(th);
      cols.forEach(k => { const th = document.createElement('th'); th.textContent = k; trh.appendChild(th); });
      thead.appendChild(trh);

      // Add data rows with checkboxes
      commands.forEach(cmd => {
        const tr = document.createElement('tr');
        const td = document.createElement('td');
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        td.appendChild(checkbox);
        tr.appendChild(td);
        tbody.appendChild(tr);

        cols.forEach(k => {
          const td = document.createElement('td');
          const v = cmd[k];
          if (typeof v === 'object' && v !== null)
            td.textContent = Object.entries(v).map(([key, value]) => `${key}: ${value}`).join(', ');
          else
            td.textContent = (v === undefined ? '' : String(v));
          tr.appendChild(td);
        });

        tr.dataset.key = cmd.key;
      });

      // Update the command count label
      document.getElementById('commandCount').textContent = commands.length + ' commands';

      // All selection functionality
      document.getElementById('selectAll').addEventListener('change', (e) => {
        const checked = e.target.checked;
        tbody.querySelectorAll('input[type="checkbox"]').forEach(el => { el.checked = checked; });
      });
    }

    function editorToTable() {
      try {
        const txt = document.getElementById('commandsArea').value;
        const obj = JSON.parse(txt);
        renderTable(obj.commands || []);
        setStatus('Table updated from editor');
      } catch (err) {
        setStatus('Invalid JSON');
      }
    }

    function handleInsert() {
      try {
        const txt = document.getElementById('commandsArea').value;
        const obj = JSON.parse(txt);
        if (!obj.commands) throw new Error("JSON must include 'commands' array");
        setStatus('Uploading...');
        fetch('/api/v1/commands/insert', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(obj)
        }).then(res => setStatus(res.ok ? 'Uploaded' : 'Upload failed'))
          .catch(() => setStatus('Invalid JSON or upload failed'));
      } catch (err) {
        setStatus('Invalid JSON or upload failed');
      }
    }

    function handleEvaluate() {
      try {
        const txt = document.getElementById('commandsArea').value;
        const obj = JSON.parse(txt);
        if (!obj.commands) throw new Error("JSON must include 'commands' array");
        setStatus('Evaluating...');
        fetch('/api/v1/commands/insert', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(obj)
        }).then(async res => {
          const text = await res.text();
          setStatus(text || (res.ok ? 'Evaluated' : 'Evaluation failed'));
        }).catch(() => setStatus('Invalid JSON or evaluation failed'));
      } catch (err) {
        setStatus('Invalid JSON or evaluation failed');
      }
    }

    function handleRemoveSelected() {
      const selectedKeys = Array.from(document.querySelectorAll('#commandsTable tbody input[type="checkbox"]:checked'))
        .map(checkbox => checkbox.closest('tr').dataset.key);

      if (selectedKeys.length > 0) {
        fetch('/api/v1/commands/remove', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ keys: selectedKeys })
        }).then(res => {
          if (res.ok) {
            setStatus('Removed selected');
            clearTextarea('commandsArea', 'size');
            fetchCommands();
          } else {
            setStatus('Removal failed');
          }
        }).catch(() => setStatus('Removal failed'));
      } else {
        setStatus('No commands selected');
      }
    }

    function handleRemoveAll() {
      fetch('/api/v1/commands/remove', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ keys: [] })
      }).then(res => {
        if (res.ok) {
          setStatus('All commands removed');
          clearTextarea('commandsArea', 'size');
          fetchCommands();
        } else {
          setStatus('Removal failed');
        }
      }).catch(() => setStatus('Removal failed'));
    }

    document.getElementById('btnHome').addEventListener('click', handleHome);
    document.getElementById('btnFetch').addEventListener('click', fetchCommands);
    document.getElementById('btnOpenFile').addEventListener('click', () => document.getElementById('fileUpload').click());
    document.getElementById('fileUpload').addEventListener('change', ev => handleJsonFileUpload(ev, 'commandsArea', updateSize));
    document.getElementById('btnClear').addEventListener('click', () => clearTextarea('commandsArea', 'size'));
    document.getElementById('btnFormat').addEventListener('click', () => formatTextareaJson('commandsArea'));
    document.getElementById('btnEvaluate').addEventListener('click', handleEvaluate);
    document.getElementById('btnInsert').addEventListener('click', handleInsert);
    document.getElementById('btnDownload').addEventListener('click', () => {
      const text = document.getElementById('commandsArea').value;
      downloadTextFile(text, 'commands.json', 'application/json');
    });
    document.getElementById('btnLoad').addEventListener('click', async () => {
      await postSimple('/api/v1/commands/load');
      clearTextarea('commandsArea', 'size');
      fetchCommands();
    });
    document.getElementById('btnSave').addEventListener('click', () => postSimple('/api/v1/commands/save'));
    document.getElementById('btnWipe').addEventListener('click', () => {
      if (confirm('Clear all commands from NVS?')) postSimple('/api/v1/commands/wipe');
    });

    document.getElementById('commandsArea').addEventListener('input', updateSize);
    document.getElementById('btnEditorToTable').addEventListener('click', editorToTable);
    document.getElementById('btnRemoveSelected').addEventListener('click', handleRemoveSelected);
    document.getElementById('btnRemoveAll').addEventListener('click', handleRemoveAll);

    document.querySelectorAll('#commandsTable tbody tr').forEach(row => {
      row.addEventListener('click', () => { row.classList.toggle('selected'); });
    });

    // Initial load
    fetchCommands();
  </script>
</body>

</html>